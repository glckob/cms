<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធគ្រប់គ្រងសាលារៀន</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans Khmer', sans-serif;
            background-color: #f0f2f5;
        }
        .font-koulen { font-family: 'Koulen', sans-serif; }
        .font-moul { font-family: 'Moul', sans-serif; }
        .modal, .page-view, .class-detail-view {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(-50%) translateY(-20px); /* Centered and initially off-screen */
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* Centered and slides in */
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Login/Register Screen -->
    <div id="auth-screen" class="flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
            <h2 class="font-moul text-2xl text-center text-blue-700 mb-6">ប្រព័ន្ធគ្រប់គ្រងសាលារៀន</h2>
            <div id="login-form-container">
                <h3 class="font-koulen text-xl mb-4">ចូលប្រើប្រាស់</h3>
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">អ៊ីមែល</label><input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">ពាក្យសម្ងាត់</label><input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">ចូលប្រើ</button>
                    <p class="text-center text-sm text-gray-600 mt-4">មិនទាន់មានគណនី? <a href="#" id="show-register-link" class="font-medium text-blue-600 hover:text-blue-500">បង្កើតគណនីថ្មី</a></p>
                </form>
            </div>
            <div id="register-form-container" class="hidden">
                 <h3 class="font-koulen text-xl mb-4">បង្កើតគណនីថ្មី</h3>
                <form id="register-form">
                    <div class="mb-4"><label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">អ៊ីមែល</label><input type="email" id="register-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">ពាក្យសម្ងាត់</label><input type="password" id="register-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">បង្កើតគណនី</button>
                     <p class="text-center text-sm text-gray-600 mt-4">មានគណនីហើយ? <a href="#" id="show-login-link" class="font-medium text-blue-600 hover:text-blue-500">ចូលប្រើប្រាស់</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="flex h-screen bg-gray-100 hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md flex flex-col">
            <div class="p-4 border-b"><h1 class="font-moul text-xl text-blue-700 text-center">គ្រប់គ្រងសាលា</h1></div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" id="nav-dashboard" class="nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg bg-blue-100"><i class="fas fa-tachometer-alt w-6 h-6 text-blue-500"></i><span class="ml-3">ផ្ទាំងគ្រប់គ្រង</span></a>
                <a href="#" id="nav-years" class="nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100"><i class="fas fa-calendar-alt w-6 h-6 text-gray-500"></i><span class="ml-3">ឆ្នាំសិក្សា</span></a>
                <a href="#" id="nav-classes" class="nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100"><i class="fas fa-school w-6 h-6 text-gray-500"></i><span class="ml-3">បន្ទុកថ្នាក់</span></a>
                <a href="#" id="nav-teachers" class="nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100"><i class="fas fa-chalkboard-teacher w-6 h-6 text-gray-500"></i><span class="ml-3">គ្រូបន្ទុកថ្នាក់</span></a>
                <a href="#" id="nav-students" class="nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100"><i class="fas fa-user-graduate w-6 h-6 text-gray-500"></i><span class="ml-3">សិស្សានុសិស្ស</span></a>
                <a href="#" id="nav-subjects" class="nav-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100"><i class="fas fa-book w-6 h-6 text-gray-500"></i><span class="ml-3">មុខវិជ្ជា</span></a>
            </nav>
            <div class="p-4 border-t">
                <p id="user-email-display" class="text-sm text-gray-600 break-words"></p>
                <button id="logout-btn" class="w-full mt-2 bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-600 text-sm"><i class="fas fa-sign-out-alt mr-2"></i>ចាកចេញ</button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-6 overflow-y-auto">
            <!-- Main Views Container -->
            <div id="main-views-container">
                <!-- Dashboard View, Years, Classes, etc. go here -->
                <div id="view-dashboard" class="page-view">
                    <h2 class="font-koulen text-2xl mb-4">ផ្ទាំងគ្រប់គ្រងទូទៅ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center justify-between"><div><p class="text-gray-500">ឆ្នាំសិក្សាសរុប</p><p id="stats-years" class="text-3xl font-bold">0</p></div><i class="fas fa-calendar-alt text-4xl text-blue-300"></i></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center justify-between"><div><p class="text-gray-500">ថ្នាក់សរុប</p><p id="stats-classes" class="text-3xl font-bold">0</p></div><i class="fas fa-school text-4xl text-green-300"></i></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center justify-between"><div><p class="text-gray-500">គ្រូសរុប</p><p id="stats-teachers" class="text-3xl font-bold">0</p></div><i class="fas fa-chalkboard-teacher text-4xl text-yellow-300"></i></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center justify-between"><div><p class="text-gray-500">សិស្សសរុប</p><p id="stats-students" class="text-3xl font-bold">0</p></div><i class="fas fa-user-graduate text-4xl text-red-300"></i></div>
                    </div>
                </div>
                <div id="view-years" class="page-view hidden"><div class="flex justify-between items-center mb-4"><h2 class="font-koulen text-2xl">គ្រប់គ្រងឆ្នាំសិក្សា</h2><button id="add-year-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700"><i class="fas fa-plus mr-2"></i>បន្ថែមឆ្នាំសិក្សា</button></div><div id="years-list" class="bg-white p-4 rounded-lg shadow-sm"></div></div>
                <div id="view-classes" class="page-view hidden"><div class="flex justify-between items-center mb-4"><h2 class="font-koulen text-2xl">គ្រប់គ្រងបន្ទុកថ្នាក់</h2><button id="add-class-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700"><i class="fas fa-plus mr-2"></i>បង្កើតថ្នាក់ថ្មី</button></div><div id="classes-list" class="bg-white p-4 rounded-lg shadow-sm"></div></div>
                <div id="view-teachers" class="page-view hidden"><div class="flex justify-between items-center mb-4"><h2 class="font-koulen text-2xl">គ្រប់គ្រងគ្រូបន្ទុកថ្នាក់</h2><button id="add-teacher-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600"><i class="fas fa-plus mr-2"></i>បន្ថែមគ្រូថ្មី</button></div><div id="teachers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                <div id="view-students" class="page-view hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-koulen text-2xl">គ្រប់គ្រងសិស្សានុសិស្ស</h2>
                        <button id="add-student-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-600"><i class="fas fa-plus mr-2"></i>បន្ថែមសិស្សថ្មី</button>
                    </div>
                    <!-- Year Filter -->
                    <div class="mb-4">
                        <label for="student-year-filter" class="block text-sm font-medium text-gray-700">ជ្រើសរើសឆ្នាំសិក្សា</label>
                        <select id="student-year-filter" class="mt-1 block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                    </div>
                    <!-- Student Stats Display -->
                    <div id="student-stats-container" class="mb-4 p-4 bg-white rounded-lg shadow-sm hidden">
                        <div class="flex flex-wrap gap-4 items-center">
                            <div>
                                <span class="text-sm text-gray-500">សិស្សក្នុងតារាង:</span>
                                <span id="student-stats-total" class="font-bold text-xl">0</span>
                            </div>
                            <div>
                                <span class="text-sm text-gray-500">សិស្សស្រី:</span>
                                <span id="student-stats-female" class="font-bold text-xl text-pink-500">0</span>
                            </div>
                            <div class="border-l pl-4 flex-1">
                                <span class="text-sm text-gray-500">សរុបតាមថ្នាក់:</span>
                                <div id="student-stats-by-class" class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                                    <!-- Stats by class will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Search Bar -->
                    <div id="student-search-container" class="mb-4 hidden">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="student-search-input" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="ស្វែងរកតាមអត្តលេខ, ឈ្មោះ, ថ្នាក់...">
                        </div>
                    </div>
                    <div id="students-list" class="bg-white p-4 rounded-lg shadow-sm overflow-x-auto"></div>
                </div>
                <div id="view-subjects" class="page-view hidden"><div class="flex justify-between items-center mb-4"><h2 class="font-koulen text-2xl">គ្រប់គ្រងមុខវិជ្ជា</h2><button id="add-subject-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700"><i class="fas fa-plus mr-2"></i>បន្ថែមមុខវិជ្ជា</button></div><div id="subjects-list" class="bg-white p-4 rounded-lg shadow-sm"></div></div>
            </div>

            <!-- Class Detail View -->
            <div id="class-detail-container" class="class-detail-view hidden">
                <button id="back-to-classes-btn" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>ត្រឡប់ទៅបញ្ជីថ្នាក់</button>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 id="class-detail-title" class="font-koulen text-3xl mb-2"></h2>
                    <p id="class-detail-teacher" class="text-gray-600 mb-4"></p>
                    
                    <!-- Tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6">
                            <button data-tab="settings" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">ការកំណត់</button>
                            <button data-tab="students" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">បញ្ជីសិស្ស</button>
                            <button data-tab="scores" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">បញ្ចូលពិន្ទុ</button>
                            <button data-tab="results" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">លទ្ធផលប្រចាំខែ</button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div class="mt-6">
                        <div id="tab-content-settings" class="tab-content">
                            <h3 class="font-koulen text-lg mb-4">កំណត់ค่าសម្រាប់ថ្នាក់</h3>
                            <form id="class-settings-form">
                                <div class="mb-4">
                                    <label for="exam-months" class="block text-sm font-medium text-gray-700">ចំនួនខែដែលត្រូវបញ្ចូលពិន្ទុ</label>
                                    <input type="number" id="exam-months" min="1" max="12" class="mt-1 block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div class="mb-4">
                                    <h4 class="block text-sm font-medium text-gray-700 mb-2">មុខវិជ្ជាត្រូវប្រឡង</h4>
                                    <div id="class-subjects-list" class="space-y-2 max-h-60 overflow-y-auto border p-3 rounded-md"></div>
                                </div>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">រក្សាទុកការកំណត់</button>
                            </form>
                        </div>
                        <div id="tab-content-students" class="tab-content hidden">
                             <h3 class="font-koulen text-lg mb-4">គ្រប់គ្រងបញ្ជីសិស្ស</h3>
                             <form id="class-students-form">
                                <div id="class-students-list" class="space-y-2 max-h-80 overflow-y-auto border p-3 rounded-md bg-gray-50"></div>
                                <button type="submit" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">រក្សាទុកបញ្ជីសិស្ស</button>
                             </form>
                        </div>
                        <div id="tab-content-scores" class="tab-content hidden">
                            <h3 class="font-koulen text-lg mb-4">បញ្ចូលពិន្ទុប្រចាំខែ</h3>
                            <div class="mb-4">
                                <label for="score-month-select" class="block text-sm font-medium text-gray-700">ជ្រើសរើសខែ</label>
                                <select id="score-month-select" class="mt-1 block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                            </div>
                            <div id="score-entry-table-container" class="overflow-x-auto"></div>
                             <button id="save-scores-btn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700">រក្សាទុកពិន្ទុ</button>
                        </div>
                        <div id="tab-content-results" class="tab-content hidden">
                            <h3 class="font-koulen text-lg mb-4">លទ្ធផល និងតារាងកិត្តិយស</h3>
                             <p class="text-gray-500">មុខងារនេះនឹងត្រូវបានបន្ថែមក្នុងពេលឆាប់ៗនេះ។</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast max-w-xs bg-gray-800 text-white p-4 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, setDoc, deleteDoc, query, where, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCOo5oxLfCCxNAd78vGEruoPm2ng-7Etmg",
            authDomain: "glckob.firebaseapp.com",
            projectId: "glckob",
            storageBucket: "glckob.appspot.com",
            messagingSenderId: "766670265981",
            appId: "1:766670265981:web:xxxxxxxxxxxx" // Replace with your actual App ID if needed
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'glckob-school-app';

        // --- GLOBAL STATE ---
        let app, auth, db, userId;
        let unsubscribeListeners = [];
        let currentClassData = null;
        let allStudentsCache = [];
        let allSubjectsCache = [];
        let allTeachersCache = [];
        let allClassesCache = [];
        let allYearsCache = [];

        // --- DOM ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const mainViewsContainer = document.getElementById('main-views-container');
        const classDetailContainer = document.getElementById('class-detail-container');
        const backToClassesBtn = document.getElementById('back-to-classes-btn');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageViews = document.querySelectorAll('.page-view');
        const addYearBtn = document.getElementById('add-year-btn');
        const addClassBtn = document.getElementById('add-class-btn');
        const addTeacherBtn = document.getElementById('add-teacher-btn');
        const addStudentBtn = document.getElementById('add-student-btn');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const studentSearchInput = document.getElementById('student-search-input');
        const studentYearFilter = document.getElementById('student-year-filter');
        const studentStatsContainer = document.getElementById('student-stats-container');
        const studentSearchContainer = document.getElementById('student-search-container');

        // --- UTILITY & NAVIGATION FUNCTIONS ---
        function showToast(message, isError = false) { const toast = document.getElementById('toast-notification'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.className = `toast max-w-xs text-white p-4 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'} show`; setTimeout(() => { toast.classList.remove('show'); }, 3000); }
        function createModal(id, title, content, footer) { const modalHTML = `<div id="${id}" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg m-4 transform -translate-y-10 flex flex-col max-h-[90vh]"><div class="flex-shrink-0 flex justify-between items-center p-4 border-b"><h3 class="font-koulen text-xl">${title}</h3><button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button></div><div class="flex-grow p-6 overflow-y-auto">${content}</div><div class="flex-shrink-0 flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">${footer}</div></div></div>`; document.getElementById('modal-container').innerHTML = modalHTML; const modal = document.getElementById(id); modal.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(id)); return modal; }
        function openModal(id) { const modal = document.getElementById(id); if(modal) { modal.classList.remove('opacity-0', 'pointer-events-none'); modal.querySelector('.modal-content').classList.remove('-translate-y-10'); } }
        function closeModal(id) { const modal = document.getElementById(id); if(modal) { modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('-translate-y-10'); setTimeout(() => { modal.classList.add('pointer-events-none'); document.getElementById('modal-container').innerHTML = ''; }, 250); } }
        function switchView(targetId) { mainViewsContainer.classList.remove('hidden'); classDetailContainer.classList.add('hidden'); pageViews.forEach(view => view.classList.add('hidden')); navLinks.forEach(link => link.classList.remove('bg-blue-100')); const targetView = document.getElementById(targetId); const targetLink = document.getElementById(`nav-${targetId.split('-')[1]}`); if (targetView) targetView.classList.remove('hidden'); if (targetLink) targetLink.classList.add('bg-blue-100'); }
        
        // --- DATA RENDERING & FILTERING ---
        function renderList(container, data, renderItemFn, emptyMessage) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 p-4 text-center">${emptyMessage}</p>`;
                return;
            }
            data.forEach(item => {
                const itemEl = renderItemFn(item);
                if (itemEl) container.appendChild(itemEl);
            });
        }

        function filterAndRenderStudents() {
            const selectedYearId = studentYearFilter.value;
            const searchTerm = studentSearchInput.value.toLowerCase();
            
            const studentsListContainer = document.getElementById('students-list');

            if (!selectedYearId) {
                studentsListContainer.innerHTML = `<p class="text-gray-500 p-4 text-center">សូមជ្រើសរើសឆ្នាំសិក្សាដើម្បីបង្ហាញទិន្នន័យសិស្ស។</p>`;
                studentStatsContainer.classList.add('hidden');
                studentSearchContainer.classList.add('hidden');
                return;
            }

            studentStatsContainer.classList.remove('hidden');
            studentSearchContainer.classList.remove('hidden');

            const classesInYear = allClassesCache.filter(c => c.academicYearId === selectedYearId);
            const studentIdsInYear = classesInYear.flatMap(c => c.studentIds || []);
            let studentsInYear = allStudentsCache.filter(s => studentIdsInYear.includes(s.id));

            let filteredStudents = studentsInYear;

            if (searchTerm) {
                filteredStudents = studentsInYear.filter(student => {
                    const studentClass = allClassesCache.find(c => c.studentIds?.includes(student.id));
                    let className = '';
                    if (studentClass) {
                        className = studentClass.className.toLowerCase();
                    }

                    return (
                        student.studentId.toLowerCase().includes(searchTerm) ||
                        student.name.toLowerCase().includes(searchTerm) ||
                        student.gender.toLowerCase().includes(searchTerm) ||
                        (student.dob && student.dob.toLowerCase().includes(searchTerm)) ||
                        (student.phone && student.phone.toLowerCase().includes(searchTerm)) ||
                        className.includes(searchTerm)
                    );
                });
            }
            
            // --- STATS CALCULATION & DISPLAY ---
            const total = filteredStudents.length;
            const females = filteredStudents.filter(s => s.gender === 'ស្រី').length;

            document.getElementById('student-stats-total').textContent = total;
            document.getElementById('student-stats-female').textContent = females;

            const statsByClassContainer = document.getElementById('student-stats-by-class');
            statsByClassContainer.innerHTML = '';

            if (classesInYear.length > 0) {
                classesInYear.forEach(c => {
                    const studentsInClass = filteredStudents.filter(s => c.studentIds?.includes(s.id));
                    
                    if (studentsInClass.length > 0) {
                        const femalesInClass = studentsInClass.filter(s => s.gender === 'ស្រី').length;
                        const statHtml = `
                            <span class="font-medium mr-3">${c.className}: 
                                <span class="font-bold">${studentsInClass.length}</span> នាក់ 
                                (<span class="text-pink-500">ស្រី ${femalesInClass}</span>)
                            </span>`;
                        statsByClassContainer.insertAdjacentHTML('beforeend', statHtml);
                    }
                });
            }
            
            if (statsByClassContainer.innerHTML === '') {
                statsByClassContainer.innerHTML = '<span class="text-gray-400">គ្មានទិន្នន័យ</span>';
            }

            renderStudentTable(studentsListContainer, filteredStudents, "រកមិនឃើញសិស្សដែលត្រូវនឹងការស្វែងរកទេ។");
        }

        function populateYearFilterDropdown() {
            studentYearFilter.innerHTML = '<option value="">-- សូមជ្រើសរើសឆ្នាំសិក្សា --</option>';
            const sortedYears = [...allYearsCache].sort((a,b) => b.startYear - a.startYear);
            sortedYears.forEach(year => {
                studentYearFilter.innerHTML += `<option value="${year.id}">${year.name}</option>`;
            });
        }

        // --- DATA SUBSCRIPTIONS & UI UPDATES ---
        function subscribeToYears() {
            const container = document.getElementById('years-list');
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/academic_years`);
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                allYearsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('stats-years').textContent = allYearsCache.length;
                renderList(container, allYearsCache.sort((a,b) => b.startYear - a.startYear), renderYearItem, "មិនទាន់មានឆ្នាំសិក្សា");
                populateYearFilterDropdown();
                filterAndRenderStudents(); 
            });
            unsubscribeListeners.push(unsubscribe);
        }

        function subscribeToTeachers() {
            const container = document.getElementById('teachers-list');
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/teachers`);
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                allTeachersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('stats-teachers').textContent = allTeachersCache.length;
                renderList(container, allTeachersCache, renderTeacherItem, "មិនទាន់មានទិន្នន័យគ្រូ");
            });
            unsubscribeListeners.push(unsubscribe);
        }

        function subscribeToStudents() {
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                allStudentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('stats-students').textContent = allStudentsCache.length;
                filterAndRenderStudents();
            });
            unsubscribeListeners.push(unsubscribe);
        }
        
        function subscribeToSubjects() {
            const container = document.getElementById('subjects-list');
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/subjects`);
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                allSubjectsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderList(container, allSubjectsCache.sort((a, b) => (a.order || 0) - (b.order || 0)), renderSubjectItem, "មិនទាន់មានមុខវិជ្ជា");
            });
            unsubscribeListeners.push(unsubscribe);
        }

        function subscribeToClasses() {
            const container = document.getElementById('classes-list');
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/classes`);
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                allClassesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('stats-classes').textContent = allClassesCache.length;
                const populatedClasses = allClassesCache.map(c => ({...c, yearName: allYearsCache.find(y => y.id === c.academicYearId)?.name || 'N/A', teacherName: allTeachersCache.find(t => t.id === c.teacherId)?.name || 'មិនទាន់កំណត់'}));
                renderList(container, populatedClasses, renderClassItem, "មិនទាន់មានថ្នាក់រៀន");
                filterAndRenderStudents();
            });
            unsubscribeListeners.push(unsubscribe);
        }

        // --- ITEM RENDERERS (with EDIT functionality) ---
        function renderYearItem(year) {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 border-b hover:bg-gray-50';
            div.innerHTML = `<span class="font-bold text-lg">${year.name}</span>
                             <div>
                                <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                             </div>`;
            div.querySelector('.edit-btn').addEventListener('click', () => openYearModal(year));
            div.querySelector('.delete-btn').addEventListener('click', async () => {
                if (confirm(`តើអ្នកពិតជាចង់លុបឆ្នាំសិក្សា ${year.name} មែនទេ? ការលុបនេះអាចប៉ះពាល់ដល់ថ្នាក់រៀនដែលពាក់ព័ន្ធ។`)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/academic_years`, year.id));
                    showToast('បានលុបឆ្នាំសិក្សា');
                }
            });
            return div;
        }

        function renderTeacherItem(teacher) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4 flex flex-col items-center text-center';
            const placeholderImg = `https://placehold.co/100x100/EBF4FF/7F9CF5?text=${teacher.name.charAt(0)}`;
            div.innerHTML = `<img src="${teacher.photoUrl || placeholderImg}" onerror="this.onerror=null;this.src='${placeholderImg}';" alt="${teacher.name}" class="w-24 h-24 rounded-full object-cover mb-4"><h4 class="font-bold text-lg">${teacher.name}</h4><p class="text-gray-600">${teacher.gender}</p><p class="text-gray-500 text-sm">${teacher.phone || 'N/A'}</p><div class="mt-4"><button class="edit-btn text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
            div.querySelector('.edit-btn').addEventListener('click', () => openTeacherModal(teacher));
            div.querySelector('.delete-btn').addEventListener('click', async () => {
                if (confirm(`តើអ្នកពិតជាចង់លុបគ្រូ ${teacher.name} មែនទេ?`)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/teachers`, teacher.id));
                    showToast('បានលុបគ្រូ');
                }
            });
            return div;
        }
        
        function renderStudentTable(container, data, emptyMessage) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 p-4 text-center">${emptyMessage}</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="p-3">ល.រ</th><th class="p-3">អត្តលេខសិស្ស</th><th class="p-3">ឈ្មោះ</th><th class="p-3">ភេទ</th><th class="p-3">ថ្នាក់/ឆ្នាំសិក្សា</th><th class="p-3">ថ្ងៃខែឆ្នាំកំណើត</th><th class="p-3">ទូរស័ព្ទ</th><th class="p-3"></th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            data.forEach((student, index) => tbody.appendChild(renderStudentItem(student, index)));
            container.appendChild(table);
        }

        function renderStudentItem(student, index) {
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            
            const studentClass = allClassesCache.find(c => c.studentIds?.includes(student.id));
            let classInfo = '<span class="text-gray-400">មិនបានចាត់ថ្នាក់</span>';
            if (studentClass) {
                const yearInfo = allYearsCache.find(y => y.id === studentClass.academicYearId);
                const yearName = yearInfo ? yearInfo.name : '';
                classInfo = `<span class="font-medium text-green-700">ថ្នាក់ទី ${studentClass.className}</span> <span class="text-sm text-gray-500">(${yearName})</span>`;
            }

            const placeholderImg = `https://placehold.co/40x40/EBF4FF/7F9CF5?text=${student.name.charAt(0)}`;
            tr.innerHTML = `
                <td class="p-3">${index + 1}</td>
                <td class="p-3 font-mono">${student.studentId}</td>
                <td class="p-3 flex items-center">
                    <img src="${student.photoUrl || placeholderImg}" onerror="this.onerror=null;this.src='${placeholderImg}';" alt="${student.name}" class="w-10 h-10 rounded-full object-cover mr-3">
                    <span class="font-medium">${student.name}</span>
                </td>
                <td class="p-3">${student.gender}</td>
                <td class="p-3">${classInfo}</td>
                <td class="p-3">${student.dob || 'N/A'}</td>
                <td class="p-3">${student.phone || 'N/A'}</td>
                <td class="p-3 text-right">
                    <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                    <button class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </td>`;
            tr.querySelector('.edit-btn').addEventListener('click', () => openStudentModal(student));
            tr.querySelector('.delete-btn').addEventListener('click', async () => {
                if (confirm(`តើអ្នកពិតជាចង់លុបសិស្ស ${student.name} មែនទេ?`)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/students`, student.id));
                    showToast('បានលុបសិស្ស');
                }
            });
            return tr;
        }

        function renderSubjectItem(subject) {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 border-b hover:bg-gray-50';
            div.innerHTML = `<div><span class="font-medium">${subject.name}</span><span class="text-sm text-gray-500 ml-2">(មេគុណ: ${subject.order})</span></div>
                             <div>
                                <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                             </div>`;
            div.querySelector('.edit-btn').addEventListener('click', () => openSubjectModal(subject));
            div.querySelector('.delete-btn').addEventListener('click', async () => {
                if (confirm(`តើអ្នកពិតជាចង់លុបមុខវិជ្ជា ${subject.name} មែនទេ?`)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/subjects`, subject.id));
                    showToast('បានលុបមុខវិជ្ជា');
                }
            });
            return div;
        }

        function renderClassItem(classData) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-sm p-4 mb-4';
            div.innerHTML = `<div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-xl text-green-700">ថ្នាក់ទី ${classData.className}</h3>
                                    <p class="text-gray-600">ឆ្នាំសិក្សា: ${classData.yearName}</p>
                                    <p class="text-gray-600">គ្រូបន្ទុកថ្នាក់: ${classData.teacherName}</p>
                                    <p class="text-gray-600">ចំនួនសិស្ស: ${classData.studentIds?.length || 0} នាក់</p>
                                </div>
                                <div class="flex flex-col items-end space-y-2">
                                    <button class="manage-btn w-full bg-blue-500 text-white px-3 py-1 rounded-md text-sm"><i class="fas fa-cog"></i> គ្រប់គ្រងថ្នាក់</button>
                                    <div class="flex">
                                        <button class="edit-btn text-yellow-500 hover:text-yellow-700 mr-2"><i class="fas fa-edit"></i> កែប្រែ</button>
                                        <button class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i> លុប</button>
                                    </div>
                                </div>
                            </div>`;
            div.querySelector('.edit-btn').addEventListener('click', () => {
                 const fullClassData = allClassesCache.find(c => c.id === classData.id);
                 openClassModal(fullClassData);
            });
            div.querySelector('.delete-btn').addEventListener('click', async () => {
                if (confirm(`តើអ្នកពិតជាចង់លុបថ្នាក់ ${classData.className} មែនទេ?`)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/classes`, classData.id));
                    showToast('បានលុបថ្នាក់');
                }
            });
            div.querySelector('.manage-btn').addEventListener('click', () => {
                const fullClassData = allClassesCache.find(c => c.id === classData.id);
                showClassDetailView({ ...fullClassData, teacherName: classData.teacherName });
            });
            return div;
        }

        // --- MODAL OPENER FUNCTIONS (with DUPLICATION CHECK) ---
        function openYearModal(year = null) {
            if (!userId) return;
            const isEditMode = year !== null;
            const currentYear = new Date().getFullYear();
            const modalId = 'year-modal';
            const title = isEditMode ? 'កែប្រែឆ្នាំសិក្សា' : 'បន្ថែមឆ្នាំសិក្សាថ្មី';
            const content = `<form id="year-form">
                <input type="hidden" id="year-id" value="${isEditMode ? year.id : ''}">
                <div class="mb-4">
                    <label for="start-year" class="block mb-2 text-sm font-medium">ឆ្នាំចាប់ផ្តើម</label>
                    <input type="number" id="start-year" value="${isEditMode ? year.startYear : currentYear}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="end-year" class="block mb-2 text-sm font-medium">ឆ្នាំបញ្ចប់</label>
                    <input type="number" id="end-year" value="${isEditMode ? year.endYear : currentYear + 1}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
            </form>`;
            const footer = `<button type="submit" form="year-form" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">រក្សាទុក</button>`;
            
            createModal(modalId, title, content, footer);
            openModal(modalId);

            document.getElementById('year-form').onsubmit = async (e) => {
                e.preventDefault();
                const yearId = document.getElementById('year-id').value;
                const startYear = document.getElementById('start-year').value;
                const endYear = document.getElementById('end-year').value;
                const yearName = `${startYear}-${endYear}`;

                const isDuplicate = allYearsCache.some(y => y.name === yearName && y.id !== yearId);
                if (isDuplicate) {
                    showToast('ឆ្នាំសិក្សានេះមានរួចហើយ។', true);
                    return;
                }

                if (startYear && endYear && parseInt(endYear) > parseInt(startYear)) {
                    const yearData = { startYear: parseInt(startYear), endYear: parseInt(endYear), name: yearName };
                    if (yearId) {
                        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/academic_years`, yearId), yearData);
                        showToast('បានកែប្រែឆ្នាំសិក្សា');
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/academic_years`), yearData);
                        showToast('បានបន្ថែមឆ្នាំសិក្សាដោយជោគជ័យ');
                    }
                    closeModal(modalId);
                } else {
                    showToast('ទិន្នន័យមិនត្រឹមត្រូវ', true);
                }
            };
        }

        function openTeacherModal(teacher = null) {
            if (!userId) return;
            const isEditMode = teacher !== null;
            const modalId = 'teacher-modal';
            const title = isEditMode ? 'កែប្រែព័ត៌មានគ្រូ' : 'បន្ថែមគ្រូថ្មី';
            const content = `<form id="teacher-form">
                <input type="hidden" id="teacher-id" value="${isEditMode ? teacher.id : ''}">
                <div class="mb-4"><label for="teacher-name" class="block mb-2 text-sm font-medium">ឈ្មោះគ្រូ</label><input type="text" id="teacher-name" value="${isEditMode ? teacher.name : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required></div>
                <div class="mb-4"><label for="teacher-gender" class="block mb-2 text-sm font-medium">ភេទ</label><select id="teacher-gender" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"><option value="ប្រុស" ${isEditMode && teacher.gender === 'ប្រុស' ? 'selected' : ''}>ប្រុស</option><option value="ស្រី" ${isEditMode && teacher.gender === 'ស្រី' ? 'selected' : ''}>ស្រី</option></select></div>
                <div class="mb-4"><label for="teacher-phone" class="block mb-2 text-sm font-medium">លេខទូរស័ព្ទ</label><input type="tel" id="teacher-phone" value="${isEditMode ? teacher.phone || '' : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></div>
                <div class="mb-4">
                    <label for="teacher-photo-url" class="block mb-2 text-sm font-medium">Link រូបថត (URL)</label>
                    <div class="relative">
                        <input type="url" id="teacher-photo-url" value="${isEditMode ? teacher.photoUrl || '' : ''}" placeholder="https://example.com/photo.jpg" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 pr-10">
                        <button type="button" id="paste-teacher-photo-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600">
                            <i class="fas fa-paste"></i>
                        </button>
                    </div>
                </div>
            </form>`;
            const footer = `<button type="submit" form="teacher-form" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">រក្សាទុក</button>`;
            
            createModal(modalId, title, content, footer);
            openModal(modalId);

            document.getElementById('paste-teacher-photo-btn').addEventListener('click', () => {
                const targetInput = document.getElementById('teacher-photo-url');
                targetInput.focus();
                try {
                    // Using execCommand is deprecated but avoids the permission prompt.
                    document.execCommand('paste');
                } catch (err) {
                    console.error('Paste command failed: ', err);
                    showToast('ការបិទភ្ជាប់ដោយស្វ័យប្រវត្តិមិនដំណើរការទេ។ សូមប្រើ Ctrl+V។', true);
                }
            });
            
            document.getElementById('teacher-form').onsubmit = async (e) => {
                e.preventDefault();
                const teacherId = document.getElementById('teacher-id').value;
                const name = document.getElementById('teacher-name').value.trim();
                const gender = document.getElementById('teacher-gender').value;
                const phone = document.getElementById('teacher-phone').value;
                const photoUrl = document.getElementById('teacher-photo-url').value;
                if (!name) { showToast("សូមបញ្ចូលឈ្មោះគ្រូ", true); return; }

                const isDuplicate = allTeachersCache.some(t => t.name.trim().toLowerCase() === name.toLowerCase() && t.id !== teacherId);
                if (isDuplicate) {
                    showToast('ឈ្មោះគ្រូនេះមានរួចហើយ។', true);
                    return;
                }

                const teacherData = { name, gender, phone, photoUrl: photoUrl || '' };
                if (teacherId) {
                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/teachers`, teacherId), teacherData);
                    showToast('បានកែប្រែព័ត៌មានគ្រូ');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/teachers`), teacherData);
                    showToast('បានបន្ថែមគ្រូថ្មីដោយជោគជ័យ');
                }
                closeModal(modalId);
            };
        }

        function openStudentModal(student = null) {
            if (!userId) return;
            const isEditMode = student !== null;
            const modalId = 'student-modal';
            const title = isEditMode ? 'កែប្រែព័ត៌មានសិស្ស' : 'បន្ថែមសិស្សថ្មី';
            const selectedYearId = studentYearFilter.value;

            let currentClassId = null;
            if (isEditMode) {
                const currentClass = allClassesCache.find(c => c.studentIds?.includes(student.id));
                if (currentClass) {
                    currentClassId = currentClass.id;
                }
            }

            const classesForSelectedYear = allClassesCache.filter(c => c.academicYearId === selectedYearId);
            const classOptions = classesForSelectedYear.map(c => 
                `<option value="${c.id}" ${currentClassId === c.id ? 'selected' : ''}>ថ្នាក់ទី ${c.className}</option>`
            ).join('');
            
            const classSelectorHtml = `
                <div class="mb-4 col-span-2">
                    <label for="student-class-select" class="block mb-2 text-sm font-medium">${isEditMode ? 'ផ្លាស់ប្តូរថ្នាក់' : 'ជ្រើសរើសថ្នាក់ដើម្បីបង្កើតអត្តលេខ'}</label>
                    <select id="student-class-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                        <option value="">-- មិនបានចាត់ថ្នាក់ --</option>
                        ${classOptions}
                    </select>
                </div>`;

            const femaleAvatar = 'https://i.ibb.co/pBsS6BrR/graduating-student.png';
            const maleAvatar = 'https://i.ibb.co/JwpwpdDW/student-1.png';

            const content = `<form id="student-form">
                <input type="hidden" id="student-doc-id" value="${isEditMode ? student.id : ''}">
                ${classSelectorHtml}
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4"><label for="student-id" class="block mb-2 text-sm font-medium">អត្តលេខសិស្ស</label><input type="text" id="student-id" value="${isEditMode ? student.studentId : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div class="mb-4"><label for="student-name" class="block mb-2 text-sm font-medium">ឈ្មោះសិស្ស</label><input type="text" id="student-name" value="${isEditMode ? student.name : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div class="mb-4"><label for="student-gender" class="block mb-2 text-sm font-medium">ភេទ</label><select id="student-gender-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"><option value="ប្រុស" ${isEditMode && student.gender === 'ប្រុស' ? 'selected' : ''}>ប្រុស</option><option value="ស្រី" ${isEditMode && student.gender === 'ស្រី' ? 'selected' : ''}>ស្រី</option></select></div>
                    <div class="mb-4"><label for="student-dob" class="block mb-2 text-sm font-medium">ថ្ងៃខែឆ្នាំកំណើត</label><input type="date" id="student-dob" value="${isEditMode ? student.dob || '' : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></div>
                    <div class="mb-4 col-span-2"><label for="student-phone" class="block mb-2 text-sm font-medium">លេខទូរស័ព្ទ</label><input type="tel" id="student-phone" value="${isEditMode ? student.phone || '' : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></div>
                    <div class="mb-4 col-span-2">
                        <label for="student-photo-url" class="block mb-2 text-sm font-medium">Link រូបថត (URL)</label>
                        <div class="relative">
                            <input type="url" id="student-photo-url" value="${isEditMode ? student.photoUrl || '' : ''}" placeholder="https://example.com/photo.jpg" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 pr-10">
                            <button type="button" id="paste-student-photo-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600">
                                <i class="fas fa-paste"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>`;
            const footer = `<button type="submit" form="student-form" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">រក្សាទុក</button>`;
            
            createModal(modalId, title, content, footer);
            openModal(modalId);

            const genderSelect = document.getElementById('student-gender-select');
            const photoUrlInput = document.getElementById('student-photo-url');
            const classSelect = document.getElementById('student-class-select');
            const studentIdInput = document.getElementById('student-id');

            document.getElementById('paste-student-photo-btn').addEventListener('click', () => {
                const targetInput = document.getElementById('student-photo-url');
                targetInput.focus();
                try {
                    // Using execCommand is deprecated but avoids the permission prompt.
                    document.execCommand('paste');
                } catch (err) {
                    console.error('Paste command failed: ', err);
                    showToast('ការបិទភ្ជាប់ដោយស្វ័យប្រវត្តិមិនដំណើរការទេ។ សូមប្រើ Ctrl+V។', true);
                }
            });

            if (!isEditMode) {
                 classSelect.addEventListener('change', () => {
                    const selectedClassId = classSelect.value;
                    if (!selectedClassId) {
                        studentIdInput.value = '';
                        return;
                    }
                    const selectedClass = allClassesCache.find(c => c.id === selectedClassId);
                    const year = allYearsCache.find(y => y.id === selectedClass.academicYearId);
                    const yearPrefix = year.startYear.toString().slice(-2);
                    const classPrefix = `${selectedClass.className}${yearPrefix}`;

                    const studentsInClass = allStudentsCache.filter(s => s.studentId.startsWith(classPrefix));
                    let nextNum = 1;
                    if (studentsInClass.length > 0) {
                        const highestNum = studentsInClass.reduce((max, s) => {
                            const numPart = parseInt(s.studentId.slice(classPrefix.length), 10);
                            return numPart > max ? numPart : max;
                        }, 0);
                        nextNum = highestNum + 1;
                    }
                    
                    const paddedNum = nextNum.toString().padStart(2, '0');
                    studentIdInput.value = `${classPrefix}${paddedNum}`;
                });
            }


            genderSelect.addEventListener('change', (e) => {
                const currentValue = photoUrlInput.value.trim();
                if (currentValue === '' || currentValue === maleAvatar || currentValue === femaleAvatar) {
                    if (e.target.value === 'ស្រី') {
                        photoUrlInput.value = femaleAvatar;
                    } else {
                        photoUrlInput.value = maleAvatar;
                    }
                }
            });

            if (!isEditMode) {
                genderSelect.dispatchEvent(new Event('change'));
            }

            document.getElementById('student-form').onsubmit = async (e) => {
                e.preventDefault();
                const studentDocId = document.getElementById('student-doc-id').value;
                const studentId = document.getElementById('student-id').value.trim();
                const name = document.getElementById('student-name').value;
                const gender = document.getElementById('student-gender-select').value;
                const dob = document.getElementById('student-dob').value;
                const phone = document.getElementById('student-phone').value;
                const photoUrl = document.getElementById('student-photo-url').value;
                
                if (!studentId || !name) { showToast("សូមបញ្ចូលអត្តលេខ និងឈ្មោះសិស្ស", true); return; }

                const isDuplicate = allStudentsCache.some(s => s.studentId === studentId && s.id !== studentDocId);
                if (isDuplicate) {
                    showToast('អត្តលេខសិស្សនេះមានរួចហើយ។', true);
                    return;
                }

                const studentData = { studentId, name, gender, dob, phone, photoUrl: photoUrl || '' };
                const newClassId = document.getElementById('student-class-select').value;

                if (studentDocId) { // Edit Mode
                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/students`, studentDocId), studentData);
                    showToast('បានកែប្រែព័ត៌មានសិស្ស');

                    const originalClass = allClassesCache.find(c => c.studentIds?.includes(studentDocId));
                    const originalClassId = originalClass ? originalClass.id : null;

                    if (newClassId !== originalClassId) {
                        if (originalClassId) {
                            const originalClassRef = doc(db, `artifacts/${appId}/users/${userId}/classes`, originalClassId);
                            await updateDoc(originalClassRef, { studentIds: arrayRemove(studentDocId) });
                        }
                        if (newClassId) {
                            const newClassRef = doc(db, `artifacts/${appId}/users/${userId}/classes`, newClassId);
                            await updateDoc(newClassRef, { studentIds: arrayUnion(studentDocId) });
                        }
                        showToast('បានផ្លាស់ប្តូរថ្នាក់សិស្សเรียบร้อยแล้ว');
                    }

                } else { // Add Mode
                    const newStudentRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students`), studentData);
                    showToast('បានបន្ថែមសិស្សថ្មី');
                    if (newClassId) {
                        const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes`, newClassId);
                        await updateDoc(classDocRef, { studentIds: arrayUnion(newStudentRef.id) });
                        showToast(`បានបន្ថែមសិស្សទៅក្នុងថ្នាក់ដោយជោគជ័យ`);
                    }
                }
                closeModal(modalId);
            };
        }

        function openSubjectModal(subject = null) {
            if (!userId) return;
            const isEditMode = subject !== null;
            const modalId = 'subject-modal';
            const title = isEditMode ? 'កែប្រែមុខវិជ្ជា' : 'បន្ថែមមុខវិជ្ជាថ្មី';
            const content = `<form id="subject-form">
                <input type="hidden" id="subject-id" value="${isEditMode ? subject.id : ''}">
                <div class="mb-4">
                    <label for="subject-name" class="block mb-2 text-sm font-medium">ឈ្មោះមុខវិជ្ជា</label>
                    <input type="text" id="subject-name" value="${isEditMode ? subject.name : ''}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="subject-order" class="block mb-2 text-sm font-medium">មេគុណ</label>
                    <input type="number" id="subject-order" value="${isEditMode ? subject.order : '1'}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                </div>
            </form>`;
            const footer = `<button type="submit" form="subject-form" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">រក្សាទុក</button>`;
            
            createModal(modalId, title, content, footer);
            openModal(modalId);
            
            document.getElementById('subject-form').onsubmit = async (e) => {
                e.preventDefault();
                const subjectId = document.getElementById('subject-id').value;
                const name = document.getElementById('subject-name').value.trim();
                const order = document.getElementById('subject-order').value;
                if (!name) { showToast('សូមបញ្ចូលឈ្មោះមុខវិជ្ជា', true); return; }

                const isDuplicate = allSubjectsCache.some(s => s.name.trim().toLowerCase() === name.toLowerCase() && s.id !== subjectId);
                if (isDuplicate) {
                    showToast('ឈ្មោះមុខវិជ្ជានេះមានរួចហើយ។', true);
                    return;
                }

                const subjectData = { name, order: parseInt(order) || 1 };
                if (subjectId) {
                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/subjects`, subjectId), subjectData);
                    showToast('បានកែប្រែមុខវិជ្ជា');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/subjects`), subjectData);
                    showToast('បានបន្ថែមមុខវិជ្ជា');
                }
                closeModal(modalId);
            };
        }

        function openClassModal(classData = null) {
            if (!userId) return;
            const isEditMode = classData !== null;
            const modalId = 'class-modal';
            const title = isEditMode ? 'កែប្រែព័ត៌មានថ្នាក់' : 'បង្កើតថ្នាក់ថ្មី';
            const yearOptions = allYearsCache.map(y => `<option value="${y.id}" ${isEditMode && classData.academicYearId === y.id ? 'selected' : ''}>${y.name}</option>`).join('');
            const teacherOptions = allTeachersCache.map(t => `<option value="${t.id}" ${isEditMode && classData.teacherId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');
            const gradeOptions = Array.from({length: 6}, (_, i) => 7 + i).map(g => `<option value="${g}" ${isEditMode && classData.grade == g ? 'selected' : ''}>${g}</option>`).join('');
            const sectionOptions = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(s => `<option value="${s}" ${isEditMode && classData.section === s ? 'selected' : ''}>${s}</option>`).join('');
            
            const content = `<form id="class-form">
                <input type="hidden" id="class-id" value="${isEditMode ? classData.id : ''}">
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="class-year" class="block mb-2 text-sm font-medium">ឆ្នាំសិក្សា</label><select id="class-year" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>${yearOptions}</select></div>
                    <div><label for="class-teacher" class="block mb-2 text-sm font-medium">គ្រូបន្ទុកថ្នាក់</label><select id="class-teacher" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>${teacherOptions}</select></div>
                    <div><label for="class-grade" class="block mb-2 text-sm font-medium">កម្រិតថ្នាក់</label><select id="class-grade" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>${gradeOptions}</select></div>
                    <div><label for="class-section" class="block mb-2 text-sm font-medium">ផ្នែក</label><select id="class-section" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>${sectionOptions}</select></div>
                </div>
            </form>`;
            const footer = `<button type="submit" form="class-form" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">${isEditMode ? 'រក្សាទុកការផ្លាស់ប្តូរ' : 'បង្កើតថ្នាក់'}</button>`;
            
            createModal(modalId, title, content, footer);
            openModal(modalId);
            
            document.getElementById('class-form').onsubmit = async (e) => {
                e.preventDefault();
                const classId = document.getElementById('class-id').value;
                const academicYearId = document.getElementById('class-year').value;
                const teacherId = document.getElementById('class-teacher').value;
                const grade = document.getElementById('class-grade').value;
                const section = document.getElementById('class-section').value;

                if (academicYearId && teacherId && grade && section) {
                    const isDuplicate = allClassesCache.some(c => 
                        c.academicYearId === academicYearId && 
                        c.grade == grade && 
                        c.section === section && 
                        c.id !== classId
                    );
                    if (isDuplicate) {
                        showToast('ថ្នាក់នេះមានរួចហើយសម្រាប់ឆ្នាំសិក្សានេះ។', true);
                        return;
                    }

                    const classUpdateData = { academicYearId, teacherId, grade, section, className: `${grade}${section}` };
                    if (classId) {
                        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/classes`, classId), classUpdateData);
                        showToast('បានកែប្រែព័ត៌មានថ្នាក់');
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/classes`), { ...classUpdateData, studentIds: [], subjectIds: [], examMonths: 1 });
                        showToast('បានបង្កើតថ្នាក់ថ្មី');
                    }
                    closeModal(modalId);
                } else {
                    showToast('សូមបំពេញគ្រប់ប្រអប់', true);
                }
            };
        }

        // --- CLASS DETAIL VIEW LOGIC ---
        function showClassDetailView(classData) {
            currentClassData = classData;
            mainViewsContainer.classList.add('hidden');
            classDetailContainer.classList.remove('hidden');

            document.getElementById('class-detail-title').textContent = `ថ្នាក់ទី ${classData.className}`;
            document.getElementById('class-detail-teacher').textContent = `គ្រូបន្ទុកថ្នាក់: ${classData.teacherName}`;

            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(`tab-content-${tab.dataset.tab}`).classList.remove('hidden');
                });
            });
            tabs[0].click(); 

            populateClassSettings();
            populateClassStudents();
            setupScoreEntryTab();
        }

        function populateClassSettings() {
            const examMonthsInput = document.getElementById('exam-months');
            examMonthsInput.value = currentClassData.examMonths || 1;

            const subjectsListContainer = document.getElementById('class-subjects-list');
            subjectsListContainer.innerHTML = '';
            const sortedSubjects = [...allSubjectsCache].sort((a,b) => (a.order || 0) - (b.order || 0));
            sortedSubjects.forEach(subject => {
                const isChecked = currentClassData.subjectIds?.includes(subject.id);
                const checkboxHtml = `<label class="flex items-center p-2 hover:bg-gray-100 rounded"><input type="checkbox" value="${subject.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}><span class="ml-3 text-sm">${subject.name}</span></label>`;
                subjectsListContainer.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        }

        function populateClassStudents() {
            const studentsListContainer = document.getElementById('class-students-list');
            studentsListContainer.innerHTML = '';
            allStudentsCache.sort((a,b) => a.name.localeCompare(b.name, 'km')).forEach(student => {
                const isChecked = currentClassData.studentIds?.includes(student.id);
                const checkboxHtml = `<label class="flex items-center p-2 hover:bg-gray-100 rounded"><input type="checkbox" value="${student.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}><span class="ml-3 text-sm">${student.name} (អត្តលេខ: ${student.studentId})</span></label>`;
                studentsListContainer.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        }
        
        async function setupScoreEntryTab() {
            const monthSelect = document.getElementById('score-month-select');
            monthSelect.innerHTML = '';
            const examMonths = currentClassData.examMonths || 0;
            for (let i = 1; i <= examMonths; i++) {
                monthSelect.innerHTML += `<option value="${i}">ខែទី ${i}</option>`;
            }
            
            monthSelect.removeEventListener('change', generateScoreTable); 
            monthSelect.addEventListener('change', generateScoreTable);
            
            if (examMonths > 0) {
                monthSelect.dispatchEvent(new Event('change'));
            } else {
                document.getElementById('score-entry-table-container').innerHTML = '<p class="text-gray-500">សូមកំណត់ចំនួនខែប្រឡងនៅក្នុងផ្ទាំង "ការកំណត់" ជាមុនសិន។</p>';
            }
        }

        async function generateScoreTable() {
            const container = document.getElementById('score-entry-table-container');
            const selectedMonth = document.getElementById('score-month-select').value;
            
            const assignedSubjectIds = currentClassData.subjectIds || [];
            const assignedSubjects = allSubjectsCache.filter(s => assignedSubjectIds.includes(s.id)).sort((a,b) => (a.order || 0) - (b.order || 0));
            const assignedStudentIds = currentClassData.studentIds || [];
            const assignedStudents = allStudentsCache.filter(s => assignedStudentIds.includes(s.id)).sort((a,b) => a.name.localeCompare(b.name, 'km'));

            if (assignedStudents.length === 0 || assignedSubjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500">សូមបន្ថែមសិស្ស និងមុខវិជ្ជាទៅក្នុងថ្នាក់នេះជាមុនសិន។</p>';
                return;
            }

            const scorePromises = assignedStudents.map(student => getDoc(doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassData.id}/scores`, student.id)));
            const scoreSnapshots = await Promise.all(scorePromises);
            const studentScoresMap = scoreSnapshots.reduce((acc, snap) => {
                if (snap.exists()) {
                    acc[snap.id] = snap.data();
                }
                return acc;
            }, {});

            let tableHtml = '<table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ឈ្មោះសិស្ស</th>';
            assignedSubjects.forEach(subject => {
                tableHtml += `<th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${subject.name}</th>`;
            });
            tableHtml += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

            assignedStudents.forEach(student => {
                tableHtml += `<tr data-student-id="${student.id}"><td>${student.name}</td>`;
                assignedSubjects.forEach(subject => {
                    const existingScore = studentScoresMap[student.id]?.[`month_${selectedMonth}`]?.[subject.id] || '';
                    tableHtml += `<td><input type="number" class="score-input w-20 border-gray-300 rounded-md" data-subject-id="${subject.id}" value="${existingScore}"></td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
        }

        // --- EVENT LISTENERS (STABLE SETUP) ---
        function setupEventListeners() {
            // Navigation
            navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = `view-${link.id.split('-')[1]}`; switchView(targetId); }); });
            backToClassesBtn.addEventListener('click', () => switchView('view-classes'));

            // Authentication
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('register-form-container').classList.remove('hidden'); authError.textContent = ''; });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form-container').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); authError.textContent = ''; });
            loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; authError.textContent = ''; try { await signInWithEmailAndPassword(auth, email, password); showToast('ការចូលប្រើប្រាស់បានជោគជ័យ!'); } catch (error) { authError.textContent = 'អ៊ីមែល ឬពាក្យសម្ងាត់មិនត្រឹមត្រូវ។'; } });
            registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; authError.textContent = ''; try { await createUserWithEmailAndPassword(auth, email, password); showToast('ការបង្កើតគណនីបានជោគជ័យ!'); } catch (error) { if (error.code === 'auth/email-already-in-use') { authError.textContent = 'អ៊ីមែលនេះត្រូវបានប្រើប្រាស់រួចហើយ។'; } else { authError.textContent = 'មានបញ្ហាក្នុងការបង្កើតគណនី។'; } } });
            logoutBtn.addEventListener('click', async () => { await signOut(auth); showToast('បានចាកចេញពីប្រព័ន្ធ។'); });

            // Add Buttons now call modal openers
            addYearBtn.addEventListener('click', () => openYearModal());
            addTeacherBtn.addEventListener('click', () => openTeacherModal());
            addStudentBtn.addEventListener('click', () => {
                const selectedYearId = studentYearFilter.value;
                if (!selectedYearId) {
                    showToast('សូមជ្រើសរើសឆ្នាំសិក្សាសិន ទើបអាចបន្ថែមសិស្សបាន។', true);
                    return;
                }
                openStudentModal();
            });
            addSubjectBtn.addEventListener('click', () => openSubjectModal());
            addClassBtn.addEventListener('click', () => openClassModal());

            // Search and Filter listeners
            studentSearchInput.addEventListener('input', filterAndRenderStudents);
            studentYearFilter.addEventListener('change', filterAndRenderStudents);

            // Class Detail View Form Submissions
            document.getElementById('class-settings-form').addEventListener('submit', async (e) => { e.preventDefault(); const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes`, currentClassData.id); const examMonths = document.getElementById('exam-months').value; const selectedSubjectIds = Array.from(document.querySelectorAll('#class-subjects-list input:checked')).map(cb => cb.value); await updateDoc(classDocRef, { examMonths: parseInt(examMonths) || 1, subjectIds: selectedSubjectIds }); currentClassData.examMonths = parseInt(examMonths) || 1; currentClassData.subjectIds = selectedSubjectIds; setupScoreEntryTab(); showToast('បានរក្សាទុកការកំណត់ថ្នាក់'); });
            document.getElementById('class-students-form').addEventListener('submit', async (e) => { e.preventDefault(); const classDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes`, currentClassData.id); const selectedStudentIds = Array.from(document.querySelectorAll('#class-students-list input:checked')).map(cb => cb.value); await updateDoc(classDocRef, { studentIds: selectedStudentIds }); currentClassData.studentIds = selectedStudentIds; showToast('បានធ្វើបច្ចុប្បន្នភាពបញ្ជីសិស្ស'); });
            document.getElementById('save-scores-btn').addEventListener('click', async () => { const selectedMonth = document.getElementById('score-month-select').value; const scoreRows = document.querySelectorAll('#score-entry-table-container tr[data-student-id]'); for (const row of scoreRows) { const studentId = row.dataset.studentId; const scoreDocRef = doc(db, `artifacts/${appId}/users/${userId}/classes/${currentClassData.id}/scores`, studentId); const scoresForMonth = {}; const scoreInputs = row.querySelectorAll('.score-input'); scoreInputs.forEach(input => { const subjectId = input.dataset.subjectId; const scoreValue = input.value; if (scoreValue !== '') { scoresForMonth[subjectId] = parseFloat(scoreValue); } }); const updatePayload = {}; updatePayload[`month_${selectedMonth}`] = scoresForMonth; await setDoc(scoreDocRef, updatePayload, { merge: true }); } showToast(`បានរក្សាទុកពិន្ទុសម្រាប់ខែទី ${selectedMonth}`); });
        }

        // --- MAIN APP START ---
        function initializeDataSubscriptions() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            subscribeToYears();
            subscribeToTeachers();
            subscribeToStudents();
            subscribeToSubjects();
            subscribeToClasses();
            switchView('view-dashboard');
        }

        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setupEventListeners();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmailDisplay.textContent = user.email;
                        authScreen.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        initializeDataSubscriptions();
                    } else {
                        userId = null;
                        unsubscribeListeners.forEach(unsub => unsub());
                        unsubscribeListeners = [];
                        authScreen.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Initialization Error:", error);
                document.body.innerHTML = `<div class="p-8 text-center text-red-600"><h1 class="text-2xl font-bold">Initialization Failed</h1><p>Could not connect to Firebase services.</p><p class="mt-4 text-sm text-gray-500">${error.message}</p></div>`;
            }
        }

        main();

    </script>
</body>
</html>
